#pragma once

#include <sys/time.h>

aspect DfatoolCPUTiming {
	struct timeval starttime;
	struct timeval stoptime;

	advice execution("% host_count(...)") : around() {
		gettimeofday(&starttime, NULL);
		tjp->proceed();
		gettimeofday(&stoptime, NULL);
		printf("[::] host_count | n_threads=%u n_elements=%lu n_elements_per_thread=%lu ",
			p.n_threads,
			n_elements,
			n_elements / p.n_threads
		);
		printf("| latency_us=%f\n",
			(stoptime.tv_sec - starttime.tv_sec) * 1000000.0 + (stoptime.tv_usec - starttime.tv_usec)
		);
	}

	advice execution("% host_select(...)") : around() {
		gettimeofday(&starttime, NULL);
		tjp->proceed();
		gettimeofday(&stoptime, NULL);
		printf("[::] host_select | n_threads=%u n_elements=%lu n_elements_per_thread=%lu ",
			p.n_threads,
			n_elements,
			n_elements / p.n_threads
		);
		printf("| latency_us=%f\n",
			(stoptime.tv_sec - starttime.tv_sec) * 1000000.0 + (stoptime.tv_usec - starttime.tv_usec)
		);
	}

	advice execution("% host_insert(...)") : around() {
		gettimeofday(&starttime, NULL);
		tjp->proceed();
		gettimeofday(&stoptime, NULL);
		printf("[::] host_insert | n_threads=%u n_elements=%lu n_elements_per_thread=%lu ",
			p.n_threads,
			n_elements,
			n_elements / p.n_threads
		);
		printf("| latency_us=%f\n",
			(stoptime.tv_sec - starttime.tv_sec) * 1000000.0 + (stoptime.tv_usec - starttime.tv_usec)
		);
	}

	advice execution("% host_delete(...)") : around() {
		gettimeofday(&starttime, NULL);
		tjp->proceed();
		gettimeofday(&stoptime, NULL);
		printf("[::] host_delete | n_threads=%u n_elements=%lu n_elements_per_thread=%lu ",
			p.n_threads,
			n_elements,
			n_elements / p.n_threads
		);
		printf("| latency_us=%f\n",
			(stoptime.tv_sec - starttime.tv_sec) * 1000000.0 + (stoptime.tv_usec - starttime.tv_usec)
		);
	}

	advice execution("% host_update(...)") : around() {
		gettimeofday(&starttime, NULL);
		tjp->proceed();
		gettimeofday(&stoptime, NULL);
		printf("[::] host_update | n_threads=%u n_elements=%lu n_elements_per_thread=%lu ",
			p.n_threads,
			n_elements,
			n_elements / p.n_threads
		);
		printf("| latency_us=%f\n",
			(stoptime.tv_sec - starttime.tv_sec) * 1000000.0 + (stoptime.tv_usec - starttime.tv_usec)
		);
	}
};
